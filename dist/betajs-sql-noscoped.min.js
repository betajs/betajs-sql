/*!
betajs-sql - v1.0.0 - 2017-03-14
Copyright (c) Pablo Iglesias
Apache-2.0 Software License.
*/
(function(){var a=this.subScope();a.binding("module","global:BetaJS.Server.Sql"),a.binding("server","global:BetaJS.Server"),a.binding("base","global:BetaJS"),a.binding("data","global:BetaJS.Data"),a.define("module:",function(){return{guid:"9955100d-6a88-451f-9a85-004523eb8589",version:"1.0.0"}}),a.assumeVersion("base:version","undefined"),a.assumeVersion("data:version","undefined"),a.define("server:Stores.SqlDatabaseStore",["data:Stores.TransformationStore","base:Objs","server:Stores.DatabaseStore"],function(a,b,c,d){return a.extend({scoped:d},function(a){return{constructor:function(b,d,e,f){var g=new c(b,d,f);a.constructor.call(this,g)},table:function(){return this.store().table()},_encodeSort:function(a){var c={};return b.iter(a,function(a,b){"id"===b&&(b="_id"),c[b]=a}),c},_encodeData:function(a){return a},_decodeData:function(a){return a}}})}),a.define("server:Databases.SqlDatabaseTable",["server:Databases.DatabaseTable","base:Promise","base:Objs","base:Types","base:Iterators.ArrayIterator"],function(a,b,c,d,e,f){return a.extend({scoped:f},{table:function(a){return a&&(this._table_id=a),this.__req?this.__req:this._database.sqldb().mapSuccess(function(){return this.__req=this._database.sqldbReqObj(),this.__sql=this._database.sqldbMod(),this.__req},this)},_encode:function(a){return a},_decode:function(a){return a},_find:function(a,c){return this.table().mapSuccess(function(d){var f=this.__formatFind(a,c);return b.funcCallback(d,d.query,f).mapSuccess(function(a,c){return b.funcCallback(a,a.toArray).mapSuccess(function(a){return new e(a)},this)},this).mapError(function(a){return a})},this)},_insertRow:function(a){return this.table().mapSuccess(function(c){var d=this.__formatInsertRow(a);return b.funcCallback(c,c.query,d).mapSuccess(function(a,b){return a[0]},this).mapError(function(a){return a})},this)},_removeRow:function(a,c){return this.table().mapSuccess(function(c){return b.funcCallback(c,c.remove,a)},this)},_updateRow:function(a,c,d){return this.table().mapSuccess(function(d){return b.funcCallback(d,d.update,a,{$set:c}).mapSuccess(function(){return c})},this)},ensureIndex:function(a){({})[a]=1,this.table().success(function(b){b.ensureIndex(c.objectBy(a,1))})},__tableName:function(){return this._table_name},__tableId:function(){return this._table_id},__formatInsertRow:function(a){var b=this.__req,d=this.__sql,e="",f="";return c.iter(a,function(a,c){e=e+c.toString()+",",f=f+"@"+c.toString()+",",b.input(c,d.VarChar,a)},this),this.__req=b,"INSERT INTO "+this.__tableName()+" ("+e.slice(0,-1)+") OUTPUT INSERTED.* VALUES ("+f.slice(0,-1)+");"},__formatFind:function(a,b){return b=b||{},"SELECT * FROM "+this.__tableName()}})}),a.define("server:Databases.SqlDatabase",["server:Databases.Database","server:Databases.SqlDatabaseTable","base:Strings","base:Types","base:Objs","base:Promise","base:Net.Uri"],function(a,b,c,d,e,f,g,h){return a.extend({scoped:h},function(a){return{constructor:function(b){d.is_string(b)?(this.__dbUri=c.strip_start(b,"mssql://"),this.__dbObject=this.cls.uriToObject(b)):(b=e.extend({database:"database",server:"localhost"},b),this.__dbObject=b,this.__dbUri=this.cls.objectToUri(b)),a.constructor.call(this),this.sql_module=require("mssql")},_tableClass:function(){return b},sqldb:function(){var a=this.__sqldb;if(!this.__sqldb){var b=this.sql_module;b.Promise=f;var c=b.Promise.create(),d=new b.Connection("mssql://"+this.__dbUri,c.asyncCallbackFunc());a=c.success(function(){this.__sqldb=d,this.__sqldbreq=new this.sql_module.Request(d)},this)}return a},sqldbMod:function(){return this.sql_module},sqldbObj:function(){return this.__sqldb},sqldbReqObj:function(){return this.__sqldbreq}}},{uriToObject:function(a){var b=g.parse(a);return{database:c.strip_start(b.path,"/"),server:b.host,port:b.port,username:b.user,password:b.password}},objectToUri:function(a){return a.path=a.database,g.build(a)}})})}).call(Scoped);