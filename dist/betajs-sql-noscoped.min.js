/*!
betajs-sql - v1.0.6 - 2020-06-10
Copyright (c) Pablo Iglesias
Apache-2.0 Software License.
*/

(function(){var a=this.subScope();a.binding("module","global:BetaJS.Data.Databases.Sql"),a.binding("base","global:BetaJS"),a.binding("data","global:BetaJS.Data"),a.define("module:",function(){return{guid:"4631f510-61c4-4a38-8065-c8e57577625b",version:"1.0.6",datetime:1591827500371}}),a.assumeVersion("base:version","undefined"),a.assumeVersion("data:version","undefined"),a.define("module:SqlDatabaseTable",["data:Databases.DatabaseTable","base:Promise","base:Objs","base:Types","base:Iterators.ArrayIterator"],function(a,b,c,d,e,f){return a.extend({scoped:f},{table:function(a){return this._table_id=a||"id",this.__req?this.__req:(this.__req=this._database.sqldb(),this.__sqlbricks=this._database.sql_bricks,this.__req)},primary_key:function(){return this._table_id},_encode:function(a){return a},_decode:function(a){return a},_find:function(a,c){var d=this.table(),f=this.__formatFind(a,c);b.create();return b.funcCallback(d,d.query,f,{}).mapSuccess(function(a){return new e(a.rows)},this).mapError(function(a){return a})},_insertRow:function(a){var c=this.table(),d=this.__formatInsertRow(a),e=b.create();return c.query(d,{},e.asyncCallbackFunc()),e.success(function(a){return a},this).error(function(a){return a},this)},_removeRow:function(a){var c=this.table(),d=this.__formatDelete(a),e=b.create();return c.query(d,{},e.asyncCallbackFunc()),e.success(function(a){return a},this).error(function(a){return a},this)},_updateRow:function(a,c){var d=this.table(),e=this.__formatUpdate(a,c),f=b.create();return d.query(e,{},f.asyncCallbackFunc()),f.success(function(a){return a},this).error(function(a){return a},this)},ensureIndex:function(a){({})[a]=1,this.table().success(function(b){b.ensureIndex(c.objectBy(a,1))})},updateByData:function(a,b){return this.updateRow(a,b)},removeByData:function(a){return this.removeRow(a)},__tableName:function(){return this._table_name},__tableId:function(){return this._table_id},__formatInsertRow:function(a){return this.__getFormatter().insert(this.__tableName(),a).toParams()},__formatDelete:function(a){var b=this.__getFormatter(),c=b.delete.apply(b).from(this.__tableName());if(a){(d.is_array(a)||d.is_object(a))&&(c=this.__extractWhereParams(a,c))}return c.toParams()},__formatUpdate:function(a,b){var c=this.__getFormatter(),e=c.update(this.__tableName(),a);if(b){(d.is_array(b)||d.is_object(b))&&(e=this.__extractWhereParams(b,e))}return e.toParams()},__formatFind:function(a,b){b=b||{};var c=this.__getFormatter(),e=c.select().from(this.__tableName());if(b.distinct&&e.distinct(b.distinct),b.columns&&e.select(b.columns),a){(d.is_array(a)||d.is_object(a))&&(e=this.__extractWhereParams(a,e))}return b.groupBy&&e.groupBy(b.groupBy),b.orderBy&&e.orderBy(b.orderBy),e.toParams()},__extractWhereParams:function(a,b){return c.iter(a,function(e,f){if(c.contains_value(this.__specialWhereParams(),f))b=this.__specialWhereParam(b,f,e);else if(d.is_object(e))b.where(e);else if(a.hasOwnProperty(f)){var g={};g[f]=e,b.where(g)}},this),b},__specialWhereParam:function(a,b,e){var f=this.__getFormatter();if("or"==b)a.where(f.or(e));else if(d.is_object(e)&&!d.is_array(e)){var g=c.keys(e)[0],h=c.values(e)[0];a.where(f[b](g,h))}else d.is_array(e)&&c.iter(e,function(c,d){a=this.__specialWhereParam(a,b,c)},this);return a},__specialWhereParams:function(){return["or","eq","notEq","lt","lte","gt","gte"]},__getFormatter:function(){return this.__sqlbricks}})}),a.define("module:SqlDatabase",["data:Databases.Database","module:SqlDatabaseTable","base:Strings","base:Types","base:Objs","base:Promise","base:Net.Uri"],function(a,b,c,d,e,f,g,h){return a.extend({scoped:h},function(a){return{constructor:function(b){d.is_string(b)?(this.__dbUri=b.substring(b.indexOf("://")+3,b.length),this.__dbObject=this.cls.uriToObject(b)):(b=e.extend({database:"database",server:"localhost"},b),this.__dbObject=b,this.__dbUri=this.cls.objectToUri(b)),a.constructor.call(this),this.sql_module=require("node-redshift"),this.sql_bricks=require("sql-bricks")},_tableClass:function(){return b},sqldb:function(){var a=this.__sqldb;if(!this.__sqldb){var b=this.sql_module,c=new b(this.__dbObject);this.__sqldb=c,a=c}return a},sqldbMod:function(){return this.sql_module},sqldbObj:function(){return this.__sqldb},sqldbReqObj:function(){return this.__sqldbreq},close:function(){this.__sqldb.close()}}},{uriToObject:function(a){var b=g.parse(c.strip_start(a,"jdbc:"));return{database:c.strip_start(b.path,"/"),host:b.host,port:b.port,user:b.user?b.user:b.queryKey.user?b.queryKey.user:null,password:b.password?b.password:b.queryKey.password?b.queryKey.password:null}},objectToUri:function(a){return a.path=a.database,g.build(a)}})})}).call(Scoped);